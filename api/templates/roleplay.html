{% extends "base.html" %}

{% block title %}{{ roleplay_config.name if roleplay_config else 'Phone Training' }} - Cold Calling Coach{% endblock %}

{% block extra_css %}
<style>
body {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
}

.training-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

/* Phone Container */
.phone-container {
    width: 380px;
    height: 680px;
    background: #000;
    border-radius: 40px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    position: relative;
    overflow: hidden;
}

.phone-screen {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 25px;
    position: relative;
    overflow: hidden;
}

/* Status Bar */
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    color: white;
    font-size: 14px;
    font-weight: 600;
}

.time {
    font-size: 16px;
}

.status-icons {
    display: flex;
    gap: 5px;
}

/* Call Interface */
.call-interface {
    height: calc(100% - 50px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    color: white;
    text-align: center;
}

/* Call Status */
.call-status {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.contact-avatar {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.contact-avatar.calling {
    animation: pulse-avatar 2s infinite;
}

@keyframes pulse-avatar {
    0%, 100% { 
        transform: scale(1);
        border-color: rgba(255, 255, 255, 0.3);
    }
    50% { 
        transform: scale(1.05);
        border-color: rgba(34, 197, 94, 0.8);
    }
}

.contact-name {
    font-size: 28px;
    font-weight: 300;
    margin-bottom: 10px;
    letter-spacing: 0.5px;
}

.contact-info {
    font-size: 16px;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 20px;
}

.call-status-text {
    font-size: 18px;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 10px;
    min-height: 25px;
}

.call-duration {
    font-size: 16px;
    color: rgba(34, 197, 94, 1);
    font-weight: 500;
    font-variant-numeric: tabular-nums;
}

/* Call Controls */
.call-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin-bottom: 30px;
}

.control-btn {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.control-btn:hover {
    transform: scale(1.1);
}

.control-btn:active {
    transform: scale(0.95);
}

.control-btn.mute {
    background: rgba(255, 255, 255, 0.2);
}

.control-btn.mute.active {
    background: rgba(239, 68, 68, 0.9);
}

.control-btn.speaker {
    background: rgba(255, 255, 255, 0.2);
}

.control-btn.speaker.active {
    background: rgba(59, 130, 246, 0.9);
}

.control-btn.mic {
    background: rgba(34, 197, 94, 0.9);
    box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
}

.control-btn.mic.recording {
    background: rgba(239, 68, 68, 0.9);
    animation: pulse-record 1.5s infinite;
}

@keyframes pulse-record {
    0%, 100% { 
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
    }
    50% { 
        box-shadow: 0 4px 30px rgba(239, 68, 68, 0.8), 0 0 0 10px rgba(239, 68, 68, 0.2);
    }
}

/* End Call Button */
.end-call-container {
    display: flex;
    justify-content: center;
}

.end-call-btn {
    width: 65px;
    height: 65px;
    border-radius: 50%;
    border: none;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    font-size: 28px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
}

.end-call-btn:hover {
    transform: scale(1.1);
    background: rgba(220, 38, 38, 1);
}

.end-call-btn:active {
    transform: scale(0.95);
}

/* Call States */
.call-interface.dialing .call-status-text {
    color: rgba(59, 130, 246, 1);
}

.call-interface.ringing .call-status-text {
    color: rgba(251, 191, 36, 1);
    animation: blink 1s infinite;
}

.call-interface.connected .call-status-text {
    color: rgba(34, 197, 94, 1);
}

.call-interface.ended .call-status-text {
    color: rgba(239, 68, 68, 1);
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.5; }
}

/* Mode Selection (before call) */
.mode-selection {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 25px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 10;
}

.mode-selection h3 {
    color: white;
    margin-bottom: 30px;
    text-align: center;
    font-weight: 300;
}

.mode-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    width: 100%;
    max-width: 280px;
}

.mode-option {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    padding: 20px;
    color: white;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.mode-option:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
}

.mode-option.selected {
    background: rgba(34, 197, 94, 0.3);
    border-color: rgba(34, 197, 94, 0.8);
}

.mode-option h5 {
    margin: 10px 0 5px 0;
    font-weight: 500;
}

.mode-option small {
    opacity: 0.8;
}

.start-call-btn {
    margin-top: 20px;
    background: rgba(34, 197, 94, 0.9);
    border: none;
    border-radius: 25px;
    padding: 15px 40px;
    color: white;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
}

.start-call-btn:hover:not(:disabled) {
    background: rgba(34, 197, 94, 1);
    transform: translateY(-2px);
}

.start-call-btn:disabled {
    background: rgba(255, 255, 255, 0.2);
    cursor: not-allowed;
    opacity: 0.6;
}

/* Feedback Section */
.feedback-section {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border-radius: 25px;
    display: none;
    flex-direction: column;
    padding: 20px;
    z-index: 10;
    overflow-y: auto;
}

.feedback-header {
    text-align: center;
    color: white;
    margin-bottom: 20px;
}

.score-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(34, 197, 94, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-size: 24px;
    font-weight: bold;
    color: white;
}

.feedback-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    color: white;
}

.feedback-item h6 {
    margin-bottom: 8px;
    color: rgba(34, 197, 94, 1);
}

.feedback-actions {
    margin-top: auto;
    display: flex;
    gap: 10px;
}

.feedback-btn {
    flex: 1;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    padding: 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.feedback-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.feedback-btn.primary {
    background: rgba(34, 197, 94, 0.9);
}

.feedback-btn.primary:hover {
    background: rgba(34, 197, 94, 1);
}

/* Live Transcript */
.live-transcript {
    position: absolute;
    bottom: 150px;
    left: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 15px;
    padding: 15px;
    color: white;
    font-size: 14px;
    max-height: 100px;
    overflow-y: auto;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
}

.live-transcript.show {
    opacity: 1;
    transform: translateY(0);
}

/* Back Button */
.back-to-dashboard {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: 25px;
    padding: 10px 20px;
    text-decoration: none;
    font-size: 14px;
    transition: all 0.3s ease;
    z-index: 100;
}

.back-to-dashboard:hover {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    text-decoration: none;
    transform: translateY(-2px);
}

/* Responsive Design */
@media (max-width: 480px) {
    .training-container {
        padding: 10px;
    }
    
    .phone-container {
        width: 100%;
        max-width: 380px;
        height: 90vh;
        max-height: 680px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="training-container">
    <!-- Back to Dashboard -->
    <a href="/dashboard" class="back-to-dashboard">
        <i class="fas fa-arrow-left me-2"></i>Dashboard
    </a>

    <div class="phone-container">
        <div class="phone-screen">
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="time" id="current-time">9:41</div>
                <div class="status-icons">
                    <i class="fas fa-signal"></i>
                    <i class="fas fa-wifi"></i>
                    <i class="fas fa-battery-three-quarters"></i>
                </div>
            </div>

            <!-- Mode Selection Screen -->
            <div class="mode-selection" id="mode-selection">
                <h3 id="roleplay-title">Choose Training Mode</h3>
                <div class="mode-grid">
                    <div class="mode-option" data-mode="practice">
                        <i class="fas fa-user-graduate fa-2x" style="color: #60a5fa;"></i>
                        <h5>Practice Mode</h5>
                        <small>Single call with detailed feedback</small>
                    </div>
                    <div class="mode-option" data-mode="marathon">
                        <i class="fas fa-running fa-2x" style="color: #fbbf24;"></i>
                        <h5>Marathon Mode</h5>
                        <small>10 calls, need 6 to pass</small>
                    </div>
                    <div class="mode-option" data-mode="legend">
                        <i class="fas fa-trophy fa-2x" style="color: #f87171;"></i>
                        <h5>Legend Mode</h5>
                        <small>6 perfect calls (sudden death)</small>
                    </div>
                </div>
                <button class="start-call-btn" id="start-call-btn" disabled>
                    Select a mode to start call
                </button>
            </div>

            <!-- Call Interface -->
            <div class="call-interface" id="call-interface" style="display: none;">
                <!-- Call Status -->
                <div class="call-status">
                    <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face" 
                         alt="Contact" class="contact-avatar" id="contact-avatar">
                    <div class="contact-name" id="contact-name">Alex Morgan</div>
                    <div class="contact-info" id="contact-info">CTO â€¢ TechCorp</div>
                    <div class="call-status-text" id="call-status-text">Calling...</div>
                    <div class="call-duration" id="call-duration">00:00</div>
                </div>

                <!-- Live Transcript -->
                <div class="live-transcript" id="live-transcript">
                    Waiting for conversation...
                </div>

                <!-- Call Controls -->
                <div style="margin-top: auto;">
                    <div class="call-controls">
                        <button class="control-btn mute" id="mute-btn" title="Mute">
                            <i class="fas fa-microphone-slash"></i>
                        </button>
                        <button class="control-btn mic" id="mic-btn" title="Hold to speak">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="control-btn speaker" id="speaker-btn" title="Speaker">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </div>
                    
                    <div class="end-call-container">
                        <button class="end-call-btn" id="end-call-btn" title="End call">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Feedback Section -->
            <div class="feedback-section" id="feedback-section">
                <div class="feedback-header">
                    <div class="score-circle" id="score-circle">85</div>
                    <h4 style="color: white; margin: 0;">Call Complete!</h4>
                    <p style="color: rgba(255,255,255,0.7); margin: 10px 0;">Here's your coaching feedback</p>
                </div>
                
                <div id="feedback-content">
                    <!-- Feedback will be populated here -->
                </div>
                
                <div class="feedback-actions">
                    <button class="feedback-btn" id="try-again-btn">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                    <button class="feedback-btn primary" id="new-mode-btn">
                        <i class="fas fa-phone me-2"></i>New Call
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Data -->
<div id="roleplay-data" 
     data-roleplay-id="{{ roleplay_id if roleplay_id else 1 }}"
     data-user-authenticated="{{ 'true' if session.get('user_id') else 'false' }}"
     style="display: none;">
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/voice-handler.js') }}"></script>
<script>
class PhoneRoleplayManager {
    constructor() {
        this.selectedMode = null;
        this.callState = 'idle'; // idle, dialing, ringing, connected, ended
        this.callStartTime = null;
        this.durationInterval = null;
        this.isRecording = false;
        this.isMuted = false;
        this.speakerOn = false;
        this.currentSession = null;
        this.isActive = false;
        this.voiceHandler = null;
        this.aiIsSpeaking = false;
        this.isProcessing = false;
        
        this.init();
    }

    init() {
        console.log('Initializing Phone Roleplay Manager...');
        
        this.updateTime();
        setInterval(() => this.updateTime(), 1000);
        
        this.loadRoleplayData();
        this.setupEventListeners();
        this.initializeModeSelection();
        
        // Initialize voice handler
        if (typeof VoiceHandler !== 'undefined') {
            this.voiceHandler = new VoiceHandler(this);
            console.log('Voice handler initialized');
        }
    }

    updateTime() {
        const now = new Date();
        const time = now.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: false 
        });
        document.getElementById('current-time').textContent = time;
    }

    loadRoleplayData() {
        const roleplayId = this.getRoleplayId();
        if (roleplayId) {
            this.loadRoleplayInfo(roleplayId);
        }
    }

    getRoleplayId() {
        const pathMatch = window.location.pathname.match(/\/roleplay\/(\d+)/);
        return pathMatch ? parseInt(pathMatch[1]) : null;
    }

    async loadRoleplayInfo(roleplayId) {
        try {
            const response = await this.apiCall(`/api/roleplay/info/${roleplayId}`);
            if (response.ok) {
                const data = await response.json();
                this.updateRoleplayUI(data);
            }
        } catch (error) {
            console.error('Error loading roleplay info:', error);
        }
    }

    updateRoleplayUI(roleplayData) {
        const titleElement = document.getElementById('roleplay-title');
        if (titleElement) {
            titleElement.textContent = roleplayData.name;
        }

        this.updateProspectInfo(roleplayData);
    }

    updateProspectInfo(roleplayData) {
        const avatarElement = document.getElementById('contact-avatar');
        const nameElement = document.getElementById('contact-name');
        const titleElement = document.getElementById('contact-info');

        if (nameElement) {
            nameElement.textContent = this.generateProspectName(roleplayData.job_title);
        }

        if (titleElement) {
            titleElement.textContent = `${roleplayData.job_title} â€¢ ${roleplayData.industry}`;
        }

        if (avatarElement) {
            // Use a more professional stock photo
            avatarElement.src = `https://images.unsplash.com/photo-${this.getAvatarId(roleplayData.job_title)}?w=150&h=150&fit=crop&crop=face`;
        }
    }

    getAvatarId(jobTitle) {
        const avatarIds = {
            'CEO': '1507003211169-0a1dd7228f2d',
            'CTO': '1472099645785-5658abf4ff4e',
            'VP of Sales': '1519345182560-3f2917c472ef',
            'Marketing Manager': '1494790108755-74612b16c1be',
            'Director': '1573496359142-b8d87734a5a2',
            'Operations Manager': '1560250097-f87d06abe96a'
        };
        return avatarIds[jobTitle] || '1507003211169-0a1dd7228f2d';
    }

    generateProspectName(jobTitle) {
        const names = {
            'CEO': ['Alex Morgan', 'Sarah Chen', 'Michael Rodriguez'],
            'CTO': ['David Kim', 'Jennifer Walsh', 'Robert Singh'],
            'VP of Sales': ['Lisa Thompson', 'Mark Johnson', 'Amanda Garcia'],
            'Marketing Manager': ['Emily Davis', 'Chris Wilson', 'Maria Lopez'],
            'Director': ['Patricia Williams', 'James Davis', 'Linda Miller'],
            'Operations Manager': ['Robert Taylor', 'Mary Anderson', 'John Wilson']
        };

        const nameList = names[jobTitle] || ['Jordan Smith', 'Taylor Brown', 'Casey Jones'];
        return nameList[Math.floor(Math.random() * nameList.length)];
    }

    setupEventListeners() {
        // Mode selection
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', () => {
                this.selectMode(option.dataset.mode);
            });
        });

        // Start call
        document.getElementById('start-call-btn').addEventListener('click', () => {
            this.startCall();
        });

        // Call controls
        document.getElementById('mic-btn').addEventListener('mousedown', () => {
            this.startRecording();
        });

        document.getElementById('mic-btn').addEventListener('mouseup', () => {
            this.stopRecording();
        });

        document.getElementById('mic-btn').addEventListener('mouseleave', () => {
            this.stopRecording();
        });

        document.getElementById('mute-btn').addEventListener('click', () => {
            this.toggleMute();
        });

        document.getElementById('speaker-btn').addEventListener('click', () => {
            this.toggleSpeaker();
        });

        document.getElementById('end-call-btn').addEventListener('click', () => {
            this.endCall();
        });

        // Feedback actions
        document.getElementById('try-again-btn').addEventListener('click', () => {
            this.tryAgain();
        });

        document.getElementById('new-mode-btn').addEventListener('click', () => {
            this.showModeSelection();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && this.callState === 'connected') {
                e.preventDefault();
                if (!this.isRecording) {
                    this.startRecording();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space' && this.isRecording) {
                e.preventDefault();
                this.stopRecording();
            }
        });
    }

    initializeModeSelection() {
        document.getElementById('mode-selection').style.display = 'flex';
        document.getElementById('call-interface').style.display = 'none';
        document.getElementById('feedback-section').style.display = 'none';
    }

    selectMode(mode) {
        this.selectedMode = mode;
        
        document.querySelectorAll('.mode-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
        
        const startBtn = document.getElementById('start-call-btn');
        startBtn.disabled = false;
        startBtn.textContent = `Start ${this.capitalizeFirst(mode)} Call`;
    }

    async startCall() {
        if (!this.selectedMode) return;

        const roleplayId = this.getRoleplayId();
        console.log('Starting phone call:', { roleplayId, mode: this.selectedMode });

        // Start actual roleplay session
        try {
            const response = await this.apiCall('/api/roleplay/start', {
                method: 'POST',
                body: JSON.stringify({
                    roleplay_id: roleplayId,
                    mode: this.selectedMode
                })
            });

            if (response.ok) {
                const data = await response.json();
                this.currentSession = data;
                this.isActive = true;
                
                // Start phone call sequence
                await this.startPhoneCallSequence(data.initial_response);
            } else {
                const errorData = await response.json();
                this.showError(errorData.error || 'Failed to start roleplay');
                return;
            }
        } catch (error) {
            console.error('Error starting roleplay:', error);
            this.showError('Network error. Please try again.');
            return;
        }
    }

    async startPhoneCallSequence(initialResponse) {
        // Hide mode selection, show call interface
        document.getElementById('mode-selection').style.display = 'none';
        document.getElementById('call-interface').style.display = 'flex';

        await this.dialingState();
        await this.ringingState();
        await this.connectedState(initialResponse);
    }

    async dialingState() {
        this.callState = 'dialing';
        this.updateCallStatus('Calling...', 'dialing');
        
        const avatar = document.getElementById('contact-avatar');
        avatar.classList.add('calling');
        
        await this.delay(2000);
    }

    async ringingState() {
        this.callState = 'ringing';
        this.updateCallStatus('Ringing...', 'ringing');
        
        await this.delay(3000);
    }

    async connectedState(initialResponse) {
        this.callState = 'connected';
        this.updateCallStatus('Connected', 'connected');
        
        // Start call timer
        this.callStartTime = Date.now();
        this.startCallTimer();
        
        // Show live transcript
        document.getElementById('live-transcript').classList.add('show');
        
        // Enable call controls
        this.enableCallControls();
        
        // Play initial AI response
        if (initialResponse) {
            await this.playAIResponseAndWaitForUser(initialResponse);
        } else {
            this.promptUserToSpeak('The prospect answered. Make your opening!');
        }
    }

    updateCallStatus(text, state) {
        const callInterface = document.getElementById('call-interface');
        const statusText = document.getElementById('call-status-text');
        
        callInterface.className = `call-interface ${state}`;
        statusText.textContent = text;
    }

    startCallTimer() {
        this.durationInterval = setInterval(() => {
            const elapsed = Date.now() - this.callStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('call-duration').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    enableCallControls() {
        document.getElementById('mic-btn').disabled = false;
        document.getElementById('mute-btn').disabled = false;
        document.getElementById('speaker-btn').disabled = false;
    }

    startRecording() {
        if (this.callState !== 'connected' || this.isMuted || this.aiIsSpeaking || this.isProcessing) return;
        
        this.isRecording = true;
        const micBtn = document.getElementById('mic-btn');
        micBtn.classList.add('recording');
        
        this.updateTranscript('ðŸŽ¤ You are speaking...');
        
        // Start voice recognition
        if (this.voiceHandler && !this.voiceHandler.isListening) {
            this.voiceHandler.startListening();
        }
    }

    stopRecording() {
        if (!this.isRecording) return;
        
        this.isRecording = false;
        const micBtn = document.getElementById('mic-btn');
        micBtn.classList.remove('recording');
        
        // Stop voice recognition
        if (this.voiceHandler && this.voiceHandler.isListening) {
            this.voiceHandler.stopListening();
        }
    }

    async processUserInput(transcript) {
        if (!this.isActive || !this.currentSession || this.isProcessing || this.aiIsSpeaking) {
            return;
        }

        console.log('Processing user input:', transcript);
        this.isProcessing = true;

        // Stop recording
        this.stopRecording();
        this.updateTranscript('Processing your response...');

        try {
            const response = await this.apiCall('/api/roleplay/respond', {
                method: 'POST',
                body: JSON.stringify({
                    user_input: transcript
                })
            });

            if (response.ok) {
                const data = await response.json();
                
                // Check if call should end
                if (!data.call_continues) {
                    await this.endCall(data.success);
                    return;
                }
                
                // Play AI response
                await this.playAIResponseAndWaitForUser(data.ai_response);
                
            } else {
                const errorData = await response.json();
                this.showError(errorData.error || 'Failed to process input');
                this.promptUserToSpeak('Sorry, please try again...');
            }
        } catch (error) {
            console.error('Error processing user input:', error);
            this.showError('Network error during call');
            this.promptUserToSpeak('Network error, please try again...');
        } finally {
            this.isProcessing = false;
        }
    }

    async playAIResponseAndWaitForUser(text) {
        try {
            this.aiIsSpeaking = true;
            this.updateTranscript(`ðŸŽ¯ Prospect: "${text}"`);

            // Try to play TTS
            try {
                const response = await this.apiCall('/api/roleplay/tts', {
                    method: 'POST',
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    
                    if (audioBlob.size > 100) {
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        await new Promise((resolve) => {
                            audio.onended = () => {
                                URL.revokeObjectURL(audioUrl);
                                resolve();
                            };
                            
                            audio.onerror = () => {
                                URL.revokeObjectURL(audioUrl);
                                resolve();
                            };
                            
                            audio.play().catch(() => resolve());
                        });
                    } else {
                        await this.simulateSpeakingTime(text);
                    }
                } else {
                    await this.simulateSpeakingTime(text);
                }
            } catch (ttsError) {
                await this.simulateSpeakingTime(text);
            }

            this.aiIsSpeaking = false;
            this.promptUserToSpeak('Your turn! Hold the microphone to respond...');
            
        } catch (error) {
            console.error('Error playing AI response:', error);
            this.aiIsSpeaking = false;
            this.promptUserToSpeak('Your turn! Hold the microphone to respond...');
        }
    }

    async simulateSpeakingTime(text) {
        const wordsPerMinute = 150;
        const words = text.split(' ').length;
        const speakingTimeMs = (words / wordsPerMinute) * 60 * 1000;
        const delay = Math.max(1000, Math.min(5000, speakingTimeMs));
        
        return new Promise(resolve => setTimeout(resolve, delay));
    }

    promptUserToSpeak(message) {
        this.updateTranscript(message);
        
        const micBtn = document.getElementById('mic-btn');
        if (micBtn) {
            micBtn.classList.add('pulse-animation');
            setTimeout(() => {
                micBtn.classList.remove('pulse-animation');
            }, 3000);
        }
    }

    updateTranscript(text) {
        document.getElementById('live-transcript').textContent = text;
    }

    toggleMute() {
        this.isMuted = !this.isMuted;
        const muteBtn = document.getElementById('mute-btn');
        
        if (this.isMuted) {
            muteBtn.classList.add('active');
        } else {
            muteBtn.classList.remove('active');
        }
    }

    toggleSpeaker() {
        this.speakerOn = !this.speakerOn;
        const speakerBtn = document.getElementById('speaker-btn');
        
        if (this.speakerOn) {
            speakerBtn.classList.add('active');
        } else {
            speakerBtn.classList.remove('active');
        }
    }

    async endCall(success = false) {
        if (!this.isActive) return;

        this.callState = 'ended';
        this.updateCallStatus('Call ended', 'ended');
        this.isActive = false;
        this.aiIsSpeaking = false;
        
        if (this.durationInterval) {
            clearInterval(this.durationInterval);
        }
        
        if (this.voiceHandler) {
            this.voiceHandler.stopListening();
        }
        
        this.stopRecording();
        document.getElementById('live-transcript').classList.remove('show');

        try {
            const response = await this.apiCall('/api/roleplay/end', {
                method: 'POST',
                body: JSON.stringify({ success: success })
            });

            if (response.ok) {
                const data = await response.json();
                setTimeout(() => {
                    this.showFeedback(data.coaching);
                }, 2000);
            }
        } catch (error) {
            console.error('Error ending roleplay:', error);
            setTimeout(() => {
                this.showFeedback(null);
            }, 2000);
        }
    }

    showFeedback(coaching) {
        document.getElementById('call-interface').style.display = 'none';
        document.getElementById('feedback-section').style.display = 'flex';
        
        if (coaching) {
            this.populateFeedback(coaching);
            this.animateScore(coaching.overall_score || 75);
        } else {
            this.animateScore(75);
        }
    }

    populateFeedback(coaching) {
        const content = document.getElementById('feedback-content');
        content.innerHTML = '';

        if (coaching.coaching) {
            if (coaching.coaching.sales_coaching) {
                content.innerHTML += `
                    <div class="feedback-item">
                        <h6><i class="fas fa-chart-line me-2"></i>Sales Performance</h6>
                        <p style="margin: 0; font-size: 14px;">${coaching.coaching.sales_coaching}</p>
                    </div>
                `;
            }
            
            if (coaching.coaching.grammar_coaching) {
                content.innerHTML += `
                    <div class="feedback-item">
                        <h6><i class="fas fa-spell-check me-2"></i>Grammar & Structure</h6>
                        <p style="margin: 0; font-size: 14px;">${coaching.coaching.grammar_coaching}</p>
                    </div>
                `;
            }
            
            if (coaching.coaching.vocabulary_coaching) {
                content.innerHTML += `
                    <div class="feedback-item">
                        <h6><i class="fas fa-book me-2"></i>Vocabulary</h6>
                        <p style="margin: 0; font-size: 14px;">${coaching.coaching.vocabulary_coaching}</p>
                    </div>
                `;
            }
            
            if (coaching.coaching.rapport_assertiveness) {
                content.innerHTML += `
                    <div class="feedback-item">
                        <h6><i class="fas fa-handshake me-2"></i>Rapport & Confidence</h6>
                        <p style="margin: 0; font-size: 14px;">${coaching.coaching.rapport_assertiveness}</p>
                    </div>
                `;
            }
        }
    }

    animateScore(targetScore) {
        const scoreElement = document.getElementById('score-circle');
        let currentScore = 0;
        const increment = targetScore / 30;
        
        const timer = setInterval(() => {
            currentScore += increment;
            if (currentScore >= targetScore) {
                currentScore = targetScore;
                clearInterval(timer);
            }
            scoreElement.textContent = Math.round(currentScore);
        }, 50);
    }

    tryAgain() {
        this.startCall();
    }

    showModeSelection() {
        document.getElementById('feedback-section').style.display = 'none';
        this.initializeModeSelection();
        this.selectedMode = null;
        
        document.querySelectorAll('.mode-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        document.getElementById('start-call-btn').disabled = true;
        document.getElementById('start-call-btn').textContent = 'Select a mode to start call';
    }

    showError(message) {
        this.updateTranscript(`âŒ Error: ${message}`);
    }

    async apiCall(endpoint, options = {}) {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
            }
        };

        const response = await fetch(endpoint, { ...defaultOptions, ...options });
        
        if (response.status === 401) {
            window.location.href = '/login';
            throw new Error('Authentication required');
        }

        return response;
    }

    capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    if (window.location.pathname.includes('/roleplay/')) {
        window.roleplayManager = new PhoneRoleplayManager();
    }
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    .pulse-animation {
        animation: pulse 1.5s infinite !important;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}